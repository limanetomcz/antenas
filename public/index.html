<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Listagem de Antenas</title>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap4.min.js"></script>
</head>
<body>
    <div class="container mt-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>Listagem de Antenas</h2>
            <div>
                <button id="newAntenaButton" class="btn btn-success mr-2">Nova Antena</button>
                <button id="logoutButton" class="btn btn-danger">Sair</button>
            </div>
        </div>
        
        <table id="antenaTable" class="table table-striped table-bordered">
            <thead class="thead-dark">
                <tr>
                    <th>ID</th>
                    <th>Descricao</th>
                    <th>Longitude</th>
                    <th>Latitude</th>
                    <th>UF</th>
                    <th>Altura</th>
                    <th>Data Implantação</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody>
                <!-- As linhas serão preenchidas automaticamente pelo DataTables -->
            </tbody>
        </table>
    </div>

    <script>
        $(document).ready(function() {
            // Valida o token antes de carregar a tabela
            const token = localStorage.getItem('token');

            if (token) {
                $.ajax({
                    url: 'http://localhost:8000/api/validate-token',
                    type: 'GET',
                    headers: { 'Authorization': `Bearer ${token}` },
                    success: function(response) {
                        // Token válido, carrega a tabela
                        carregarTabela();
                    },
                    error: function() {
                        // Token inválido, exibe alerta e redireciona para o login
                        alert('Sessão expirada. Faça login novamente.');
                        window.location.href = 'login.html';
                    }
                });
            } else {
                // Redireciona se não houver token
                alert('Faça login para acessar esta página.');
                window.location.href = 'login.html';
            }

            function carregarTabela() {
                $('#antenaTable').DataTable({
                    ajax: {
                        url: 'http://localhost:8000/api/antenas',
                        dataSrc: '',
                        headers: { 'Authorization': `Bearer ${token}` }
                    },
                    columns: [
                        { data: 'id' },
                        { data: 'descricao' },
                        { data: 'longitude' },
                        { data: 'latitude' },
                        { data: 'uf' },
                        { data: 'altura' },
                        { data: 'data_implantacao' },
                        { 
                            data: 'id',
                            render: function(data, type, row) {
                                return `
                                    <a href="edit.html?id=${data}" class="btn btn-primary btn-sm mr-2">
                                        <i class="fas fa-edit"></i> Editar
                                    </a>
                                    <button class="btn btn-danger btn-sm delete-btn" data-id="${data}">
                                        <i class="fas fa-trash"></i> Excluir
                                    </button>
                                `;
                            }
                        }
                    ],
                    language: {
                        url: "//cdn.datatables.net/plug-ins/1.11.5/i18n/Portuguese-Brasil.json"
                    }
                });
            }

            // Evento de exclusão
            $('#antenaTable').on('click', '.delete-btn', function() {
                const antenaId = $(this).data('id');
                
                if (confirm('Tem certeza que deseja remover esta antena?')) {
                    $.ajax({
                        url: `http://localhost:8000/api/antenas/${antenaId}`,
                        type: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` },
                        success: function(response) {
                            alert('Antena removida com sucesso!');
                            $('#antenaTable').DataTable().ajax.reload();
                        },
                        error: function() {
                            alert('Erro ao remover antena.');
                        }
                    });
                }
            });

            // Botão "Nova Antena"
            $('#newAntenaButton').on('click', function() {
                window.location.href = 'new.html';
            });

            // Botão "Sair"
            $('#logoutButton').on('click', function() {
                // Redireciona para a página de login
                window.location.href = 'login.html';
            });
        });
    </script>
</body>
</html>
